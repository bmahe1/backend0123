# File: backend0123/azure-pipelines.yml

# Trigger for pipeline repo ITSELF (optional)
trigger:
  branches:
    include:
      - main

# ==============================================
# ⭐ THE MAGIC: External Repo Configuration
# ==============================================
resources:
  repositories:
    - repository: external_source  # Alias for your source repo
      type: github
      name: bmahe1/azure-backend-pipeline1  # GitHub repo
      endpoint: bmahe1  # GitHub service connection
      
      # ⭐ FIXED: Use specific branch, NOT variable
      ref: refs/heads/main  # Or refs/heads/master
      
      # ⭐⭐ THIS IS WHAT MAKES IT TRIGGER FROM EXTERNAL REPO
      trigger:
        branches:
          include:
            - main
        paths:
          include:
            - '**'  # Trigger on ANY file change
        # Optional: Exclude certain paths
        exclude:
          - README.md
          - '**/*.md'

# ==============================================
# VARIABLES
# ==============================================
variables:
  dockerRegistryServiceConnection: 'docker-external'
  dockerHubRepository: 'maheshbmahesh/azure-backend'
  dockerfilePath: 'backend/Dockerfile'
  tag: '$(Build.BuildId)'
  imagePullSecret: 'testfourids-auth'

# ==============================================
# STAGES
# ==============================================
stages:
- stage: Build
  displayName: Build Stage
  jobs:
  - job: BuildJob
    pool: 'my-agent-0vm'
    steps:
    
    # ⭐ CRITICAL STEP 1: Checkout external source repo
    - checkout: external_source
      displayName: 'Checkout source code from azure-backend-pipeline1'
      path: s/source
    
    # ⭐ CRITICAL STEP 2: Debug to verify trigger
    - script: |
        echo "=========================================="
        echo "EXTERNAL REPO TRIGGER VERIFICATION"
        echo "=========================================="
        echo "Build Reason: $(Build.Reason)"
        echo "Expected: 'ResourceTrigger' or 'IndividualCI'"
        echo "Source Branch: $(Build.SourceBranch)"
        echo "Triggering Repository: $(Build.Repository.Name)"
        echo "=========================================="
        
        # Check which repo triggered
        if [ "$(Build.Reason)" = "ResourceTrigger" ]; then
          echo "✅ TRIGGERED BY: External Repository (azure-backend-pipeline1)"
          echo "✅ Resources.TriggeringAlias: $(Resources.TriggeringAlias)"
        else
          echo "✅ TRIGGERED BY: Pipeline Repository (backend0123)"
        fi
        
        echo "✅ Source code checked out at: $(Pipeline.Workspace)/s/source"
        ls -la $(Pipeline.Workspace)/s/source/
        echo "=========================================="
      displayName: 'Verify External Repo Trigger'
    
    # Rest of your build steps...
    - task: Maven@4
      inputs:
        mavenPomFile: 's/source/pom.xml'
        goals: 'clean install -DskipTests=true'
    
    - task: Docker@2
      displayName: 'Build Docker Image'
      inputs:
        command: build
        repository: 'azure-backend-local'
        dockerfile: 's/source/$(dockerfilePath)'
        tags: |
          $(tag)
        buildContext: 's/source'
    
    # ... rest of your pipeline
