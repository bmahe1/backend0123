# ==========================================================
#  PIPELINE CONFIGURATION
# ==========================================================
# File: backend0123/azure-pipelines.yml

# Trigger on changes in THIS repo (backend0123)
trigger:
  branches:
    include:
      - develop
      - main
      - master
      - dev
      - qa
      - prod

# ==========================================================
#  EXTERNAL SOURCE CODE REPOSITORY
# ==========================================================
resources:
  repositories:
    - repository: sourcecode  # Alias for reference
      type: github
      name: bmahe1/azure-backend-pipeline1  # Your source repo
      ref: refs/heads/$(Build.SourceBranchName)  # Match pipeline branch
      endpoint: bmahe1  # GitHub service connection
      # ⭐ CRITICAL: This makes pipeline trigger on source repo changes
      trigger:
        branches:
          include:
            - develop
            - main
            - master
            - dev
            - qa
            - prod

# ==========================================================
#  VARIABLES
# ==========================================================
variables:
  dockerRegistryServiceConnection: 'docker-external'
  dockerHubRepository: 'maheshbmahesh/azure-backend'
  dockerfilePath: 'backend/Dockerfile'
  tag: '$(Build.BuildId)'
  imagePullSecret: 'testfourids-auth'

# ==========================================================
#  STAGE 1 — BUILD + SCAN + PUSH
# ==========================================================
stages:
- stage: Build
  displayName: 'Build, Scan & Push'
  jobs:
  - job: BuildJob
    pool: 'my-agent-0vm'
    steps:
      # ⭐ STEP 1: Checkout source code from azure-backend-pipeline1
      - checkout: sourcecode
        displayName: 'Checkout source code from azure-backend-pipeline1'
        path: s/source
      
      # ⭐ DEBUG: Verify checkout
      - script: |
          echo "=== DEBUG: What was checked out? ==="
          echo "Pipeline triggered by: $(Build.Reason)"
          echo "Triggering repo: $(Build.Repository.Name)"
          echo "Source repo checked out to: $(Pipeline.Workspace)/s/source"
          echo "Files in source repo:"
          ls -la $(Pipeline.Workspace)/s/source/
          echo "=== END DEBUG ==="
        displayName: 'Debug: Verify Source Code Checkout'
      
      # Maven Build
      - task: Maven@4
        displayName: 'Maven Build'
        inputs:
          mavenPomFile: 's/source/pom.xml'
          goals: 'clean install -DskipTests=true'
      
      # Build Docker image locally
      - task: Docker@2
        displayName: 'Build Docker Image'
        inputs:
          command: build
          repository: 'azure-backend-local'
          dockerfile: 's/source/$(dockerfilePath)'
          tags: |
            $(tag)
          buildContext: 's/source'
      
      # Install Trivy
      - task: Bash@3
        displayName: 'Install Trivy'
        inputs:
          targetType: inline
          script: |
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
      
      # Run Trivy Scan
      - task: Bash@3
        displayName: 'Security Scan with Trivy'
        inputs:
          targetType: inline
          script: |
            ./bin/trivy image --severity HIGH,CRITICAL,MEDIUM --ignore-unfixed azure-backend-local:$(tag)
      
      # Push Docker image to Docker Hub
      - task: Docker@2
        displayName: 'Push to Docker Hub'
        inputs:
          command: buildAndPush
          repository: $(dockerHubRepository)
          dockerfile: 's/source/$(dockerfilePath)'
          containerRegistry: $(dockerRegistryServiceConnection)
          tags: |
            $(tag)
          buildContext: 's/source'
      
      # Publish manifests
      - task: PublishPipelineArtifact@1
        displayName: 'Publish K8s Manifests'
        inputs:
          targetPath: 's/source/deployment/base'
          artifact: 'deployment-base'
      
      # Final status
      - script: |
          echo "✅ BUILD COMPLETE"
          echo "Source: azure-backend-pipeline1 ($(Build.SourceBranchName))"
          echo "Image: $(dockerHubRepository):$(tag)"
          echo "Pipeline: backend0123"
        displayName: 'Build Complete'

# ==========================================================
#  STAGE 2 — DEPLOYMENT
# ==========================================================
- stage: Deploy
  displayName: 'Deploy to Environment'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployJob
    environment: 'TestFourids'
    pool: 'my-agent-0vm'
    strategy:
      runOnce:
        deploy:
          steps:
            # Download manifests
            - task: DownloadPipelineArtifact@2
              displayName: 'Download K8s Manifests'
              inputs:
                artifact: 'deployment-base'
                path: '$(Pipeline.Workspace)/deployment/base'
            
            # Create Docker pull secret
            - task: KubernetesManifest@0
              displayName: 'Create Docker Secret'
              inputs:
                kubernetesServiceConnection: 'cluster2'
                action: createSecret
                secretName: $(imagePullSecret)
                dockerRegistryEndpoint: $(dockerRegistryServiceConnection)
            
            # Deploy to Kubernetes
            - task: KubernetesManifest@0
              displayName: 'Deploy to Kubernetes'
              inputs:
                kubernetesServiceConnection: 'cluster2'
                action: deploy
                manifests: |
                  $(Pipeline.Workspace)/deployment/base/configmap.yaml
                  $(Pipeline.Workspace)/deployment/base/deployment.yaml
                  $(Pipeline.Workspace)/deployment/base/service.yaml
                imagePullSecrets: |
                  $(imagePullSecret)
                containers: |
                  $(dockerHubRepository):$(tag)
